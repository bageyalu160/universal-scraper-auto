name: '"advanced_antidetect" ("advanced_antidetect") æ•°æ®åˆ†æ'
run-name: 'ğŸ§  "advanced_antidetect" ("advanced_antidetect") æ•°æ®åˆ†æ #${{ github.run_number
  }} (${{ github.actor }})'
on:
  workflow_dispatch:
    inputs:
      data_date:
        description: æ•°æ®æ—¥æœŸ
        required: true
        type: string
      data_file:
        description: æ•°æ®æ–‡ä»¶è·¯å¾„
        required: true
        type: string
      site_id:
        default: '"advanced_antidetect"'
        description: ç«™ç‚¹ID
        required: true
        type: string
permissions:
  actions: write
  contents: write
env:
  AI_PROVIDER: gemini
  CONFIG_DIR: config
  DATA_DIR: data/daily
  LOGS_DIR: logs
  PROMPT_DIR: config/analysis/prompts
  PYTHONUNBUFFERED: 1
  SITES_DIR: config/sites
  STATUS_DIR: status
  WORKFLOW_TYPE: analyzer
jobs:
  analyze:
    name: åˆ†ææ•°æ®
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          cache: pip
          python-version: '3.10'
      - if: true
        name: ç¼“å­˜ä¾èµ–å’Œæ•°æ®
        uses: actions/cache@v3
        with:
          key: analyzer-deps-"advanced_antidetect"-openai-${{ hashFiles('**/requirements.txt,
            config/sites/"advanced_antidetect".yaml') }}
          path: "~/.cache/pip\nanalysis/\"advanced_antidetect\"/cache"
          restore-keys: analyzer-deps-"advanced_antidetect"-openai-
      - name: å®‰è£…ä¾èµ–
        run: pip install pandas>=2.0.3 openai>=1.0.0 google-generativeai>=0.3.1 numpy>=1.22.0
          openai>=1.0.0
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |-
          mkdir -p analysis/"advanced_antidetect"
          mkdir -p analysis/"advanced_antidetect"/cache
      - env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        name: è¿è¡Œåˆ†æ
        run: |
          python scripts/ai_analyzer.py \
            --site "${{ github.event.inputs.site_id }}" \
            --date "${{ github.event.inputs.data_date }}" \
            --input "${{ github.event.inputs.data_file }}" \
            --output "analysis/${{ github.event.inputs.site_id }}/${{ github.event.inputs.site_id }}_${{ github.event.inputs.data_date }}_analysis.json" \
            --prompt-template "default" \
            --provider "openai"
      - name: ä¸Šä¼ åˆ†æç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.site_id }}-analysis-${{ github.event.inputs.data_date
            }}
          path: analysis/${{ github.event.inputs.site_id }}/${{ github.event.inputs.site_id
            }}_${{ github.event.inputs.data_date }}_analysis.json
          retention-days: 7
      - name: æäº¤æ›´æ”¹
        run: |
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ æ–‡ä»¶
          git add analysis/advanced_antidetect/

          # æäº¤æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ§  è‡ªåŠ¨æ›´æ–°: "advanced_antidetect"åˆ†æç»“æœ (${{ github.event.inputs.data_date }})"
            git push
            echo "âœ… æˆåŠŸæäº¤æ›´æ”¹"
          fi
