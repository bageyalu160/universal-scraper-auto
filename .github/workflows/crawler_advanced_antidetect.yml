name: '"advanced_antidetect" çˆ¬è™«'
run-name: 'ðŸ•·ï¸ "advanced_antidetect" çˆ¬è™« #${{ github.run_number }} (${{ github.actor
  }})'
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
    inputs:
      date:
        description: æ•°æ®æ—¥æœŸ (ç•™ç©ºåˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ)
        required: false
        type: string
      use_proxy:
        default: false
        description: æ˜¯å¦ä½¿ç”¨ä»£ç†
        required: false
        type: boolean
permissions:
  actions: write
  contents: write
env:
  CONFIG_DIR: config
  DATA_DIR: data/daily
  ENGINE_TYPE: custom
  LOGS_DIR: logs
  PROXY_ENABLED: false
  PYTHONUNBUFFERED: 1
  SITES_DIR: config/sites
  SITE_ID: '"advanced_antidetect"'
  STATUS_DIR: status
  WORKFLOW_TYPE: crawler
concurrency:
  cancel-in-progress: true
  group: crawler-"advanced_antidetect"-${{ github.ref }}
jobs:
  crawl:
    name: è¿è¡Œçˆ¬è™«
    if: always() && needs.pre-check.outputs.site_config_valid == 'true' && (needs.check-proxy.result
      == 'success' || needs.pre-check.outputs.use_proxy != 'true')
    needs:
      - pre-check
      - check-proxy
    runs-on: ubuntu-latest
    env:
      RUN_DATE: ${{ needs.pre-check.outputs.run_date }}
      USE_PROXY: ${{ needs.pre-check.outputs.use_proxy }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          cache: pip
          python-version: '3.10'
      - if: true
        name: ç¼“å­˜ä¾èµ–å’Œæ•°æ®
        uses: actions/cache@v3
        with:
          key: crawler-deps-"advanced_antidetect"-custom-${{ hashFiles('requirements.txt')
            }}
          path: "~/.cache/pip\ndata/\"advanced_antidetect\"/cache"
          restore-keys: crawler-deps-"advanced_antidetect"-custom-
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "å®‰è£…å¿…è¦çš„ä¾èµ–..."
            pip install ["requests>=2.31.0", "beautifulsoup4>=4.12.2", "lxml>=4.9.3", "fake-useragent>=1.0.0"]
          fi
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |-
          mkdir -p data/"advanced_antidetect"
          mkdir -p status/"advanced_antidetect"
          mkdir -p logs
      - continue-on-error: true
        env: {}
        id: run_scraper
        name: è¿è¡Œçˆ¬è™«
        run: |
          echo "ðŸ•·ï¸ å¼€å§‹çˆ¬å–æ•°æ®: "advanced_antidetect""
          echo "ðŸ“… è¿è¡Œæ—¥æœŸ: $RUN_DATE"
          echo "ðŸ”„ ä½¿ç”¨ä»£ç†: $USE_PROXY"

          # æž„å»ºå‘½ä»¤å‚æ•°
          PROXY_ARG=""
          if [ "$USE_PROXY" = "true" ] && [ -f "data/proxies/proxy_pool.json" ]; then
            PROXY_ARG="--proxy-file data/proxies/proxy_pool.json"
            echo "ðŸ“‹ ä½¿ç”¨ä»£ç†æ± æ–‡ä»¶"
          fi

          # æ‰§è¡Œçˆ¬è™«
          python scripts/scraper.py \
            --site "advanced_antidetect" \
            --date "$RUN_DATE" \
            --output "data/"advanced_antidetect"/data/advanced_antidetect_data.json" \
            --status "status/"advanced_antidetect"/status.json" \
            --log-file "logs/"advanced_antidetect"_$RUN_DATE.log" \
            $PROXY_ARG

          # æ£€æŸ¥ç»“æžœ
          if [ -f "data/"advanced_antidetect"/data/advanced_antidetect_data.json" ]; then
            echo "scraper_success=true" >> $GITHUB_OUTPUT
            echo "âœ… çˆ¬è™«æ‰§è¡ŒæˆåŠŸ"
          else
            echo "scraper_success=false" >> $GITHUB_OUTPUT
            echo "âŒ çˆ¬è™«æ‰§è¡Œå¤±è´¥æˆ–æ— æ•°æ®"
          fi
      - if: steps.run_scraper.outputs.scraper_success == 'true'
        name: ä¸Šä¼ æ•°æ®æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: '"advanced_antidetect"-data-${{ needs.pre-check.outputs.run_date }}'
          path: data/"advanced_antidetect"/data/advanced_antidetect_data.json
          retention-days: 7
      - name: ä¸Šä¼ çŠ¶æ€æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: '"advanced_antidetect"-status-${{ needs.pre-check.outputs.run_date
            }}'
          path: status/"advanced_antidetect"/status.json
          retention-days: 7
      - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: '"advanced_antidetect"-logs-${{ needs.pre-check.outputs.run_date }}'
          path: logs/"advanced_antidetect"_${{ needs.pre-check.outputs.run_date }}.log
          retention-days: 3
      - name: æäº¤æ›´æ”¹
        run: |
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ æ–‡ä»¶
          git add data/advanced_antidetect/
          git add status/advanced_antidetect/

          # æäº¤æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°: "advanced_antidetect"çˆ¬è™«ç»“æžœ ($RUN_DATE)"
            git push
            echo "âœ… æˆåŠŸæäº¤æ›´æ”¹"
          fi
  check-proxy:
    name: æ£€æŸ¥ä»£ç†å¯ç”¨æ€§
    if: needs.pre-check.outputs.use_proxy == 'true'
    needs:
      - pre-check
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          cache: pip
          python-version: '3.10'
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "å®‰è£…å¿…è¦çš„ä¾èµ–..."
            pip install requests pyyaml
          fi
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |-
          mkdir -p data/proxies
          mkdir -p status/proxies
          mkdir -p logs
      - id: check_proxy_pool
        name: æ£€æŸ¥ä»£ç†æ± çŠ¶æ€
        run: |
          # æ£€æŸ¥ä»£ç†çŠ¶æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "status/proxies/pool_status.json" ]; then
            echo "æ‰¾åˆ°ä»£ç†æ± çŠ¶æ€æ–‡ä»¶"
            
            # æ£€æŸ¥å¯ç”¨ä»£ç†æ•°é‡
            VALID_COUNT=$(jq '.valid_count' status/proxies/pool_status.json)
            THRESHOLD=5
            
            echo "å½“å‰æœ‰æ•ˆä»£ç†æ•°: $VALID_COUNT"
            echo "æœ€ä½Žéœ€æ±‚é˜ˆå€¼: $THRESHOLD"
            
            if [ "$VALID_COUNT" -ge "$THRESHOLD" ]; then
              echo "âœ… ä»£ç†æ± çŠ¶æ€è‰¯å¥½ï¼Œæœ‰è¶³å¤Ÿçš„ä»£ç†"
              echo "sufficient=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ ä»£ç†æ± ä¸­çš„æœ‰æ•ˆä»£ç†ä¸è¶³ï¼Œéœ€è¦æ›´æ–°"
              echo "sufficient=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä»£ç†æ± çŠ¶æ€æ–‡ä»¶ï¼Œéœ€è¦åˆå§‹åŒ–ä»£ç†æ± "
            echo "sufficient=false" >> $GITHUB_OUTPUT
          fi
      - if: steps.check_proxy_pool.outputs.sufficient == 'false'
        name: æ›´æ–°ä»£ç†æ± 
        run: |
          echo "å¼€å§‹æ›´æ–°ä»£ç†æ± ..."

          # å°è¯•æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æžœå¤±è´¥åˆ™å°è¯•æ¢å¤
          python scripts/proxy_manager.py update --min-count 10 --timeout 10

          # æ£€æŸ¥æ›´æ–°åŽçš„çŠ¶æ€
          if [ -f "status/proxies/pool_status.json" ]; then
            valid_count=$(jq '.valid_count' status/proxies/pool_status.json)
            echo "æ›´æ–°åŽçš„æœ‰æ•ˆä»£ç†æ•°: $valid_count"
            
            # å¦‚æžœæ›´æ–°åŽä»£ç†ä»ç„¶ä¸è¶³ï¼Œå°è¯•æ¢å¤å¤‡ä»½
            if [ "$valid_count" -lt "5" ] && [ -f "data/proxies/proxy_pool_backup.json" ]; then
              echo "âš ï¸ æ›´æ–°åŽä»£ç†ä»ç„¶ä¸è¶³ï¼Œå°è¯•æ¢å¤å¤‡ä»½..."
              cp data/proxies/proxy_pool_backup.json data/proxies/proxy_pool.json
              python scripts/proxy_manager.py validate --timeout 5
              
              if [ -f "status/proxies/pool_status.json" ]; then
                valid_count=$(jq '.valid_count' status/proxies/pool_status.json)
                echo "æ¢å¤å¤‡ä»½åŽçš„æœ‰æ•ˆä»£ç†æ•°: $valid_count"
              fi
            fi
            
            echo "æ›´æ–°åŽçš„æœ‰æ•ˆä»£ç†æ•°: $valid_count"
          else
            echo "âš ï¸ æ›´æ–°åŽä»æœªæ‰¾åˆ°ä»£ç†æ± çŠ¶æ€æ–‡ä»¶"
          fi
      - name: æäº¤æ›´æ”¹
        run: |
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ æ–‡ä»¶
          git add data/proxies/
          git add status/proxies/

          # æäº¤æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ðŸ”„ çˆ¬è™«ä»»åŠ¡å‰çš„ä»£ç†æ± æ›´æ–° (ç«™ç‚¹: "advanced_antidetect")"
            git push
            echo "âœ… æˆåŠŸæäº¤æ›´æ”¹"
          fi
  pre-check:
    name: çŽ¯å¢ƒä¸Žé…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      cache_key: ${{ steps.prepare_env.outputs.cache_key }}
      run_date: ${{ steps.prepare_env.outputs.date }}
      site_config_valid: ${{ steps.validate_config.outputs.valid }}
      use_proxy: ${{ steps.prepare_env.outputs.use_proxy }}
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - id: prepare_env
        name: å‡†å¤‡çŽ¯å¢ƒå˜é‡
        run: |
          # è®¾ç½®è¿è¡Œæ—¥æœŸ
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "ä½¿ç”¨æŒ‡å®šæ—¥æœŸ: ${{ github.event.inputs.date }}"
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "ä½¿ç”¨å½“å‰æ—¥æœŸ"
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

          # ç”Ÿæˆç¼“å­˜é”®
          if [ -f "requirements.txt" ]; then
            HASH=$(sha256sum requirements.txt | cut -d ' ' -f 1 | head -c 8)
            echo "cache_key=deps-"advanced_antidetect"-$HASH-v1" >> $GITHUB_OUTPUT
          else
            echo "cache_key=deps-"advanced_antidetect"-default-v1" >> $GITHUB_OUTPUT
          fi

          # è®¾ç½®æ˜¯å¦ä½¿ç”¨ä»£ç†
          USE_PROXY="${{ github.event.inputs.use_proxy || 'false' }}"
          echo "use_proxy=$USE_PROXY" >> $GITHUB_OUTPUT
          echo "ä»£ç†ä½¿ç”¨è®¾ç½®: $USE_PROXY"
      - id: validate_config
        name: éªŒè¯ç«™ç‚¹é…ç½®
        run: |
          if [ -f "config/sites/"advanced_antidetect".yaml" ]; then
            echo "âœ… ç«™ç‚¹é…ç½®æœ‰æ•ˆ"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
