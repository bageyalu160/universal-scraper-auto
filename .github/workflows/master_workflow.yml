name: ä¸»è°ƒåº¦å·¥ä½œæµ
run-name: 'ðŸš€ ä¸»è°ƒåº¦å·¥ä½œæµ #${{ github.run_number }} (${{ github.actor }})'
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
    inputs:
      action:
        description: æ‰§è¡Œæ“ä½œ
        options:
          - crawl_all
          - analyze_all
          - update_dashboard
          - update_proxy_pool
          - full_pipeline
        required: true
        type: choice
      date:
        description: æ•°æ®æ—¥æœŸ (ç•™ç©ºåˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ)
        required: false
        type: string
      site_id:
        description: ç«™ç‚¹ID (ä»…é€‚ç”¨äºŽå•ç«™ç‚¹æ“ä½œ)
        required: false
        type: string
permissions:
  actions: write
  contents: write
  id-token: write
  pages: write
env:
  CONFIG_DIR: config
  DATA_DIR: data/daily
  LOGS_DIR: logs
  PYTHONUNBUFFERED: 1
  SITES_DIR: config/sites
  STATUS_DIR: status
  WORKFLOW_TYPE: master
concurrency:
  cancel-in-progress: true
  group: master-workflow-${{ github.ref }}
jobs:
  setup:
    name: å‡†å¤‡çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.set-date.outputs.date }}
      sites: ${{ steps.list-sites.outputs.sites }}
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - id: set-date
        name: è®¾ç½®æ—¥æœŸ
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
      - id: list-sites
        name: åˆ—å‡ºå¯ç”¨ç«™ç‚¹
        run: |
          if [ -n "${{ github.event.inputs.site_id }}" ]; then
            SITES="[\"${{ github.event.inputs.site_id }}\"]"
          else
            SITES="["
            FIRST=true
            for site in config/sites/*.yaml; do
              SITE_ID=$(basename $site .yaml)
              if [ "$SITE_ID" = "example" ]; then
                continue
              fi
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                SITES="$SITES,"
              fi
              SITES="$SITES\"$SITE_ID\""
            done
            SITES="$SITES]"
          fi
          echo "sites=$SITES" >> $GITHUB_OUTPUT
          echo "å‘çŽ°ç«™ç‚¹: $SITES"
      - name: çŽ¯å¢ƒä¿¡æ¯æ”¶é›†
        run: |
          echo "=== çŽ¯å¢ƒä¿¡æ¯ ==="
          echo "è¿è¡Œæ—¶é—´: $(date)"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ“ä½œç±»åž‹: ${{ github.event.inputs.action || 'å®šæ—¶ä»»åŠ¡' }}"
          echo "æŒ‡å®šç«™ç‚¹: ${{ github.event.inputs.site_id || 'å…¨éƒ¨ç«™ç‚¹' }}"
          echo "æŒ‡å®šæ—¥æœŸ: ${{ github.event.inputs.date || 'å½“å‰æ—¥æœŸ' }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "=== é¡¹ç›®ç»“æž„æ£€æŸ¥ ==="
          ls -la config/sites/ | head -10
          echo "=== æ•°æ®ç›®å½•æ£€æŸ¥ ==="
          if [ -d "data/daily" ]; then
            echo "æœ€è¿‘çš„æ•°æ®ç›®å½•:"
            ls -la data/daily/ | tail -5
          else
            echo "æ•°æ®ç›®å½•ä¸å­˜åœ¨"
          fi
  update_proxy_pool:
    name: æ›´æ–°ä»£ç†æ± 
    if: github.event.inputs.action == 'update_proxy_pool' || github.event.inputs.action
      == 'full_pipeline' || github.event_name == 'schedule'
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘ä»£ç†æ± æ›´æ–°å·¥ä½œæµ
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: '{"action": "update"}'
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: proxy_pool_manager.yml
  crawl:
    name: çˆ¬å–æ•°æ®
    if: always() && (github.event.inputs.action == 'crawl_all' || github.event.inputs.action
      == 'full_pipeline' || github.event_name == 'schedule') && (needs.update_proxy_pool.result
      == 'success' || needs.update_proxy_pool.result == 'skipped')
    needs:
      - setup
      - update_proxy_pool
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        site_id: ${{ fromJSON(needs.setup.outputs.sites) }}
    steps:
      - name: è§¦å‘çˆ¬è™«å·¥ä½œæµ
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: '{"date": "${{ needs.setup.outputs.date }}"}'
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: crawler_${{ matrix.site_id }}.yml
  analyze:
    name: åˆ†æžæ•°æ®
    if: always() && (github.event.inputs.action == 'analyze_all' || github.event.inputs.action
      == 'full_pipeline' || github.event_name == 'schedule') && (needs.crawl.result
      == 'success' || needs.crawl.result == 'skipped')
    needs:
      - setup
      - crawl
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        site_id: ${{ fromJSON(needs.setup.outputs.sites) }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - id: get-latest-file
        name: èŽ·å–æœ€æ–°æ•°æ®æ–‡ä»¶
        run: |
          SITE_ID="${{ matrix.site_id }}"
          DATE="${{ needs.setup.outputs.date }}"
          DATA_DIR="data/daily/$DATE"

          echo "=== æ•°æ®æ–‡ä»¶æŸ¥æ‰¾ ==="
          echo "ç«™ç‚¹ID: $SITE_ID"
          echo "æ•°æ®æ—¥æœŸ: $DATE"
          echo "æ•°æ®ç›®å½•: $DATA_DIR"

          if [ -d "$DATA_DIR" ]; then
            # æŸ¥æ‰¾åŒ¹é…çš„æ•°æ®æ–‡ä»¶
            DATA_FILE=$(find $DATA_DIR -name "${SITE_ID}*.json" -type f | sort | tail -1)
            
            if [ -n "$DATA_FILE" ]; then
              echo "data_file=$DATA_FILE" >> $GITHUB_OUTPUT
              echo "found=true" >> $GITHUB_OUTPUT
              echo "âœ… æ‰¾åˆ°æ•°æ®æ–‡ä»¶: $DATA_FILE"
            else
              echo "data_file=" >> $GITHUB_OUTPUT
              echo "found=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®æ–‡ä»¶"
              echo "å°è¯•æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶:"
              find $DATA_DIR -type f | head -5
            fi
          else
            echo "data_file=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ•°æ®ç›®å½•ä¸å­˜åœ¨: $DATA_DIR"
            echo "å¯ç”¨çš„æ•°æ®ç›®å½•:"
            if [ -d "data/daily" ]; then
              ls -1 data/daily/ | tail -3
            else
              echo "data/daily ç›®å½•ä¸å­˜åœ¨"
            fi
          fi
      - if: steps.get-latest-file.outputs.data_file != ''
        name: è§¦å‘åˆ†æžå·¥ä½œæµ
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: "{\n  \"data_date\": \"${{ needs.setup.outputs.date }}\",\n  \"\
            data_file\": \"${{ steps.get-latest-file.outputs.data_file }}\",\n  \"\
            site_id\": \"${{ matrix.site_id }}\"\n}\n"
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: analyzer_${{ matrix.site_id }}.yml
  update_dashboard:
    name: æ›´æ–°ä»ªè¡¨ç›˜
    if: always() && (github.event.inputs.action == 'update_dashboard' || github.event.inputs.action
      == 'full_pipeline' || github.event_name == 'schedule') && (needs.analyze.result
      == 'success' || needs.analyze.result == 'skipped')
    needs:
      - setup
      - analyze
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘ä»ªè¡¨ç›˜æ›´æ–°å·¥ä½œæµ
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: '{"date": "${{ needs.setup.outputs.date }}"}'
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: dashboard.yml
  workflow_summary:
    name: å·¥ä½œæµæ€»ç»“
    if: always()
    needs:
      - setup
      - update_proxy_pool
      - crawl
      - analyze
      - update_dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: mkdir -p status/workflow
      - name: ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        run: |
          echo "=== ðŸš€ ä¸»å·¥ä½œæµæ‰§è¡Œæ‘˜è¦ ==="
          echo "æ‰§è¡Œæ—¥æœŸ: ${{ needs.setup.outputs.date }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ“ä½œç±»åž‹: ${{ github.event.inputs.action || 'å®šæ—¶ä»»åŠ¡' }}"
          echo "å¤„ç†ç«™ç‚¹: ${{ needs.setup.outputs.sites }}"
          echo ""
          echo "=== ðŸ“Š å„æ­¥éª¤æ‰§è¡Œç»“æžœ ==="
          echo "1ï¸âƒ£ çŽ¯å¢ƒå‡†å¤‡: ${{ needs.setup.result }}"
          echo "2ï¸âƒ£ ä»£ç†æ± æ›´æ–°: ${{ needs.update_proxy_pool.result }}"
          echo "3ï¸âƒ£ æ•°æ®çˆ¬å–: ${{ needs.crawl.result }}"
          echo "4ï¸âƒ£ æ•°æ®åˆ†æž: ${{ needs.analyze.result }}"
          echo "5ï¸âƒ£ ä»ªè¡¨ç›˜æ›´æ–°: ${{ needs.update_dashboard.result }}"
          echo ""
          echo "=== ðŸ”— ç›¸å…³é“¾æŽ¥ ==="
          echo "å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [[ "${{ needs.update_dashboard.result }}" == "success" ]]; then
            echo "ç›‘æŽ§ä»ªè¡¨ç›˜: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi
          echo ""

          # åˆ›å»ºçŠ¶æ€æ–‡ä»¶
          mkdir -p status/workflow
          cat > status/workflow/master_workflow_summary.json << EOF
          {
            "workflow_id": "${{ github.run_id }}",
            "trigger": "${{ github.event_name }}",
            "action": "${{ github.event.inputs.action || 'å®šæ—¶ä»»åŠ¡' }}",
            "date": "${{ needs.setup.outputs.date }}",
            "sites": ${{ needs.setup.outputs.sites }},
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "results": {
              "setup": "${{ needs.setup.result }}",
              "proxy_pool": "${{ needs.update_proxy_pool.result }}",
              "crawl": "${{ needs.crawl.result }}",
              "analyze": "${{ needs.analyze.result }}",
              "dashboard": "${{ needs.update_dashboard.result }}"
            },
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          echo "âœ… æ‰§è¡Œæ‘˜è¦å·²ä¿å­˜åˆ° status/workflow/master_workflow_summary.json"
      - name: æäº¤æ›´æ”¹
        run: |
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ æ–‡ä»¶
          git add status/workflow/

          # æäº¤æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ðŸ“Š è‡ªåŠ¨æ›´æ–°: ä¸»å·¥ä½œæµæ‰§è¡Œæ‘˜è¦ (${{ needs.setup.outputs.date }})"
            git push
            echo "âœ… æˆåŠŸæäº¤æ›´æ”¹"
          fi
  notify_completion:
    name: é€šçŸ¥å®Œæˆ
    if: always()
    needs:
      - setup
      - update_proxy_pool
      - crawl
      - analyze
      - update_dashboard
      - workflow_summary
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          cache: pip
          python-version: '3.10'
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
      - env:
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK }}
          WECHAT_WORK_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK }}
        id: send_notification
        name: å‡†å¤‡é€šçŸ¥å†…å®¹å¹¶å‘é€
        run: |
          # åˆ›å»ºå·¥ä½œæµçŠ¶æ€æ–‡ä»¶
          mkdir -p temp-notification
          cat > temp-notification/master_workflow_status.json << EOF
          {
            "workflow_status": {
              "setup": "${{ needs.setup.result }}",
              "proxy_pool": "${{ needs.update_proxy_pool.result }}",
              "crawl": "${{ needs.crawl.result }}",
              "analyze": "${{ needs.analyze.result }}",
              "dashboard": "${{ needs.update_dashboard.result }}",
              "date": "${{ needs.setup.outputs.date }}",
              "sites": ${{ needs.setup.outputs.sites }},
              "action": "${{ github.event.inputs.action || 'å®šæ—¶ä»»åŠ¡' }}",
              "run_id": "${{ github.run_id }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
          }
          EOF

          # å‘é€é€šçŸ¥
          echo "ðŸ“¢ å‘é€ä¸»å·¥ä½œæµå®Œæˆé€šçŸ¥..."
          python scripts/notify.py --file "temp-notification/master_workflow_status.json" --site "ä¸»å·¥ä½œæµ"
