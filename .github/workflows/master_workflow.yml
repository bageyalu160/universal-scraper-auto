name: 主调度工作流
run-name: '🚀 主调度工作流 #${{ github.run_number }} (${{ github.actor }})'
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
    inputs:
      action:
        description: 执行操作
        options:
          - crawl_all
          - analyze_all
          - update_dashboard
          - update_proxy_pool
          - full_pipeline
        required: true
        type: choice
      date:
        description: 数据日期 (留空则使用当前日期)
        required: false
        type: string
      site_id:
        description: 站点ID (仅适用于单站点操作)
        required: false
        type: string
permissions:
  actions: write
  contents: write
  id-token: write
  pages: write
jobs:
  setup:
    name: 准备环境
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.set-date.outputs.date }}
      sites: ${{ steps.list-sites.outputs.sites }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      - id: set-date
        name: 设置日期
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
      - id: list-sites
        name: 列出可用站点
        run: |
          if [ -n "${{ github.event.inputs.site_id }}" ]; then
            SITES="[\"${{ github.event.inputs.site_id }}\"]"
          else
            SITES="["
            FIRST=true
            for site in config/sites/*.yaml; do
              SITE_ID=$(basename $site .yaml)
              if [ "$SITE_ID" = "example" ]; then
                continue
              fi
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                SITES="$SITES,"
              fi
              SITES="$SITES\"$SITE_ID\""
            done
            SITES="$SITES]"
          fi
          echo "sites=$SITES" >> $GITHUB_OUTPUT
          echo "发现站点: $SITES"
      - name: 环境信息收集
        run: |
          echo "=== 环境信息 ==="
          echo "运行时间: $(date)"
          echo "触发方式: ${{ github.event_name }}"
          echo "操作类型: ${{ github.event.inputs.action || '定时任务' }}"
          echo "指定站点: ${{ github.event.inputs.site_id || '全部站点' }}"
          echo "指定日期: ${{ github.event.inputs.date || '当前日期' }}"
          echo "运行ID: ${{ github.run_id }}"
          echo "=== 项目结构检查 ==="
          ls -la config/sites/ | head -10
          echo "=== 数据目录检查 ==="
          if [ -d "data/daily" ]; then
            echo "最近的数据目录:"
            ls -la data/daily/ | tail -5
          else
            echo "数据目录不存在"
          fi
  update_proxy_pool:
    name: 更新代理池
    if: github.event.inputs.action == 'update_proxy_pool' || github.event.inputs.action == 'full_pipeline' || github.event_name
      == 'schedule'
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: 触发代理池工作流
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: '{"action": "update"}'
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: proxy_pool_manager.yml
  crawl:
    name: 爬取数据
    if: always() && (github.event.inputs.action == 'crawl_all' || github.event.inputs.action == 'full_pipeline' || github.event_name
      == 'schedule') && (needs.update_proxy_pool.result == 'success' || needs.update_proxy_pool.result == 'skipped')
    needs:
      - setup
      - update_proxy_pool
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site_id: ${{ fromJSON(needs.setup.outputs.sites) }}
    steps:
      - name: 触发爬虫工作流
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: '{"date": "${{ needs.setup.outputs.date }}"}'
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: crawler_${{ matrix.site_id }}.yml
  analyze:
    name: 分析数据
    if: always() && (github.event.inputs.action == 'analyze_all' || github.event.inputs.action == 'full_pipeline' || github.event_name
      == 'schedule') && (needs.crawl.result == 'success' || needs.crawl.result == 'skipped')
    needs:
      - setup
      - crawl
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site_id: ${{ fromJSON(needs.setup.outputs.sites) }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      - id: get-latest-file
        name: 获取最新数据文件
        run: |
          SITE_ID="${{ matrix.site_id }}"
          DATE="${{ needs.setup.outputs.date }}"
          DATA_DIR="data/daily/$DATE"

          echo "=== 数据文件查找 ==="
          echo "站点ID: $SITE_ID"
          echo "目标日期: $DATE"
          echo "数据目录: $DATA_DIR"

          if [ -d "$DATA_DIR" ]; then
            echo "✅ 数据目录存在"
            echo "目录内容:"
            ls -la "$DATA_DIR" | grep -E "(${SITE_ID}|\.json|\.csv)" || echo "无相关文件"
            
            FILE=$(find $DATA_DIR -name "*${SITE_ID}*" -type f | sort | tail -n 1)
            if [ -n "$FILE" ]; then
              echo "data_file=$FILE" >> $GITHUB_OUTPUT
              echo "found=true" >> $GITHUB_OUTPUT
              echo "✅ 找到数据文件: $FILE"
              echo "文件大小: $(du -h "$FILE" | cut -f1)"
              echo "文件时间: $(ls -l "$FILE" | awk '{print $6, $7, $8}')"
            else
              echo "data_file=" >> $GITHUB_OUTPUT
              echo "found=false" >> $GITHUB_OUTPUT
              echo "⚠️ 未找到匹配的数据文件"
              echo "尝试查找所有文件:"
              find $DATA_DIR -type f | head -5
            fi
          else
            echo "data_file=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
            echo "⚠️ 数据目录不存在: $DATA_DIR"
            echo "可用的数据目录:"
            if [ -d "data/daily" ]; then
              ls -1 data/daily/ | tail -3
            else
              echo "data/daily 目录不存在"
            fi
          fi
      - if: steps.get-latest-file.outputs.data_file != ''
        name: 触发分析工作流
        uses: benc-uk/workflow-dispatch@v1
        with:
          inputs: "{\n  \"data_date\": \"${{ needs.setup.outputs.date }}\",\n  \"data_file\": \"${{ steps.get-latest-file.outputs.data_file
            }}\",\n  \"site_id\": \"${{ matrix.site_id }}\"\n}\n"
          token: ${{ secrets.GITHUB_TOKEN }}
          workflow: analyzer_${{ matrix.site_id }}.yml
  update_dashboard:
    name: 更新仪表盘
    if: always() && (github.event.inputs.action == 'update_dashboard' || github.event.inputs.action == 'full_pipeline' ||
      github.event_name == 'schedule') && (needs.analyze.result == 'success' || needs.analyze.result == 'skipped')
    needs:
      - setup
      - analyze
    uses: ./.github/workflows/update_dashboard.yml
  workflow_summary:
    name: 执行摘要
    if: always()
    needs:
      - setup
      - update_proxy_pool
      - crawl
      - analyze
      - update_dashboard
    runs-on: ubuntu-latest
    steps:
      - name: 生成执行摘要
        run: |
          echo "=== 🚀 主调度工作流执行摘要 ==="
          echo "执行时间: $(date)"
          echo "运行ID: ${{ github.run_id }}"
          echo "触发方式: ${{ github.event_name }}"
          echo "执行操作: ${{ github.event.inputs.action || '定时任务' }}"
          echo "目标站点: ${{ github.event.inputs.site_id || '全部站点' }}"
          echo "数据日期: ${{ needs.setup.outputs.date }}"
          echo ""
          echo "=== 📊 各阶段执行结果 ==="
          echo "1️⃣ 环境准备: ${{ needs.setup.result }}"
          echo "2️⃣ 代理池更新: ${{ needs.update_proxy_pool.result }}"
          echo "3️⃣ 数据爬取: ${{ needs.crawl.result }}"
          echo "4️⃣ 数据分析: ${{ needs.analyze.result }}"
          echo "5️⃣ 仪表盘更新: ${{ needs.update_dashboard.result }}"
          echo ""
          echo "=== 🔗 相关链接 ==="
          echo "工作流运行: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [[ "${{ needs.update_dashboard.result }}" == "success" ]]; then
            echo "监控仪表盘: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi
          echo ""

          # 创建状态文件
          mkdir -p status/workflow
          cat > status/workflow/master_workflow_summary.json << EOF
          {
            "workflow_id": "${{ github.run_id }}",
            "trigger": "${{ github.event_name }}",
            "action": "${{ github.event.inputs.action || '定时任务' }}",
            "date": "${{ needs.setup.outputs.date }}",
            "sites": ${{ needs.setup.outputs.sites }},
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "results": {
              "setup": "${{ needs.setup.result }}",
              "proxy_pool": "${{ needs.update_proxy_pool.result }}",
              "crawl": "${{ needs.crawl.result }}",
              "analyze": "${{ needs.analyze.result }}",
              "dashboard": "${{ needs.update_dashboard.result }}"
            },
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          echo "✅ 执行摘要已保存到 status/workflow/master_workflow_summary.json"
  notify_completion:
    name: 通知完成
    if: always()
    needs:
      - setup
      - update_proxy_pool
      - crawl
      - analyze
      - update_dashboard
      - workflow_summary
    runs-on: ubuntu-latest
    steps:
      - id: prepare_message
        name: 准备通知内容
        run: |
          FAILED_JOBS=""
          if [[ "${{ needs.update_proxy_pool.result }}" != "success" && "${{ needs.update_proxy_pool.result }}" != "skipped" ]]; then
            FAILED_JOBS="$FAILED_JOBS 代理池更新,"
          fi
          if [[ "${{ needs.crawl.result }}" != "success" && "${{ needs.crawl.result }}" != "skipped" ]]; then
            FAILED_JOBS="$FAILED_JOBS 爬虫阶段,"
          fi
          if [[ "${{ needs.analyze.result }}" != "success" && "${{ needs.analyze.result }}" != "skipped" ]]; then
            FAILED_JOBS="$FAILED_JOBS 分析阶段,"
          fi
          if [[ "${{ needs.update_dashboard.result }}" != "success" && "${{ needs.update_dashboard.result }}" != "skipped" ]]; then
            FAILED_JOBS="$FAILED_JOBS 仪表盘更新,"
          fi

          if [[ -z "$FAILED_JOBS" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### ✅ 数据流程全部完成" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **日期**: ${{ needs.setup.outputs.date }}" >> $GITHUB_OUTPUT
            echo "- **站点**: ${{ github.event.inputs.site_id || '全部站点' }}" >> $GITHUB_OUTPUT
            echo "- **操作**: ${{ github.event.inputs.action || '定时任务' }}" >> $GITHUB_OUTPUT
            echo "- **运行ID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            FAILED_JOBS=${FAILED_JOBS%,}  # 移除最后的逗号
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### ❌ 数据流程部分失败" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **日期**: ${{ needs.setup.outputs.date }}" >> $GITHUB_OUTPUT
            echo "- **站点**: ${{ github.event.inputs.site_id || '全部站点' }}" >> $GITHUB_OUTPUT
            echo "- **失败阶段**: $FAILED_JOBS" >> $GITHUB_OUTPUT
            echo "- **运行ID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      - id: check_dingtalk
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'dingtalk'
        name: 检查钉钉通知配置
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT
      - if: steps.check_dingtalk.outputs.has_webhook == 'true'
        name: 发送钉钉通知
        uses: fifsky/dingtalk-action@master
        with:
          content: "${{ steps.prepare_message.outputs.message }}\n"
          type: markdown
          url: ${{ secrets.DINGTALK_WEBHOOK }}
      - id: check_wechat
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'wechat'
        name: 检查企业微信配置
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT
      - if: steps.check_wechat.outputs.has_webhook == 'true'
        name: 发送企业微信通知
        uses: chf007/action-wechat-work@master
        with:
          content: ${{ steps.prepare_message.outputs.message }}
          key: ${{ secrets.WECHAT_WEBHOOK }}
          msgtype: markdown
