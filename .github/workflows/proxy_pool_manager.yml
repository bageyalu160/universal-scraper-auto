name: ä»£ç†æ± ç®¡ç†å™¨

run-name: "ğŸ”„ ä»£ç†æ± æ›´æ–° #${{ github.run_number }} (${{ github.actor }})"

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: "0 */4 * * *"
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œæ“ä½œ'
        required: true
        type: choice
        options:
          - update # æ›´æ–°ä»£ç†æ± 
          - validate # éªŒè¯ç°æœ‰ä»£ç†
          - clear # æ¸…ç©ºå¤±è´¥çš„ä»£ç†
          - rebuild # å®Œå…¨é‡å»ºä»£ç†æ± 
          - recover # å°è¯•æ¢å¤å¤±è´¥çš„ä»£ç†
      proxy_source:
        description: 'ä»£ç†æºç±»å‹ (ç•™ç©ºåˆ™ä½¿ç”¨æ‰€æœ‰é…ç½®æº)'
        required: false
        type: choice
        options:
          - all
          - api
          - file
      threshold:
        description: 'è§¦å‘æ¢å¤çš„ä»£ç†æ•°é‡é˜ˆå€¼(é»˜è®¤ä¸º5)'
        required: false
        type: number
        default: 5
      debug:
        description: 'è°ƒè¯•æ¨¡å¼'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.10"
  TZ: "Asia/Shanghai"

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: bash

jobs:
  proxy-pool-management:
    name: ç®¡ç†ä»£ç†æ± 
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºè®¿é—®ä»£ç†æ± çŠ¶æ€
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "å®‰è£…å¿…è¦çš„ä¾èµ–..."
            pip install requests pyyaml pandas
          fi
      
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p data/proxies
          mkdir -p status/proxies
          mkdir -p logs
          
      - name: åŠ è½½å†å²ä»£ç†çŠ¶æ€
        id: load_history
        run: |
          # æ£€æŸ¥ä»£ç†çŠ¶æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "status/proxies/pool_status.json" ]; then
            echo "å‘ç°å†å²ä»£ç†æ± çŠ¶æ€æ–‡ä»¶"
            echo "history_exists=true" >> $GITHUB_OUTPUT
            
            # è·å–ä»£ç†æ•°é‡ç»Ÿè®¡
            valid_count=$(cat status/proxies/pool_status.json | jq '.stats.valid_count')
            failed_count=$(cat status/proxies/pool_status.json | jq '.stats.failed_count')
            
            echo "å†å²ä»£ç†ç»Ÿè®¡: æœ‰æ•ˆä»£ç† $valid_count ä¸ª, å¤±æ•ˆä»£ç† $failed_count ä¸ª"
            echo "valid_count=$valid_count" >> $GITHUB_OUTPUT
            echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          else
            echo "æœªå‘ç°å†å²ä»£ç†æ± çŠ¶æ€"
            echo "history_exists=false" >> $GITHUB_OUTPUT
            echo "valid_count=0" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: ç¡®å®šæ“ä½œç±»å‹
        id: determine_action
        run: |
          # è·å–ç”¨æˆ·æŒ‡å®šçš„æ“ä½œæˆ–ä½¿ç”¨é»˜è®¤æ“ä½œ
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ github.event.inputs.action }}"
          else
            # æ ¹æ®å†å²çŠ¶æ€å†³å®šé»˜è®¤æ“ä½œ
            if [ "${{ steps.load_history.outputs.valid_count }}" -lt "10" ]; then
              # å¦‚æœä»£ç†æ•°é‡å°‘äº10ï¼Œé¦–å…ˆå°è¯•æ¢å¤ï¼Œå¦‚æœæ¢å¤ä¸æˆåŠŸå†é‡å»º
              ACTION="recover"
              FALLBACK="rebuild"
            else
              ACTION="update"
              FALLBACK="validate"
            fi
          fi
          
          echo "æ‰§è¡Œæ“ä½œ: $ACTION"
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          
          # ç¡®å®šå¤‡ç”¨æ“ä½œ
          if [ -n "$FALLBACK" ]; then
            echo "å¤‡ç”¨æ“ä½œ: $FALLBACK"
            echo "fallback=$FALLBACK" >> $GITHUB_OUTPUT
          fi
          
          # ç¡®å®šä»£ç†æº
          if [ "${{ github.event.inputs.proxy_source }}" == "" ] || [ "${{ github.event.inputs.proxy_source }}" == "all" ]; then
            PROXY_SOURCE="all"
          else
            PROXY_SOURCE="${{ github.event.inputs.proxy_source }}"
          fi
          
          echo "ä»£ç†æº: $PROXY_SOURCE"
          echo "proxy_source=$PROXY_SOURCE" >> $GITHUB_OUTPUT
          
          # ç¡®å®šé˜ˆå€¼
          if [ "${{ github.event.inputs.threshold }}" == "" ]; then
            THRESHOLD=5
          else
            THRESHOLD="${{ github.event.inputs.threshold }}"
          fi
          
          echo "æ¢å¤é˜ˆå€¼: $THRESHOLD"
          echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
      
      - name: è¿è¡Œä»£ç†æ± ç®¡ç†è„šæœ¬
        id: run_manager
        env:
          PROXY_API_KEY: ${{ secrets.PROXY_API_KEY }}
          PROXY_SOURCE_URL: ${{ secrets.PROXY_SOURCE_URL }}
          DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
        run: |
          # è®¾ç½®è°ƒè¯•æ¨¡å¼
          if [ "$DEBUG_MODE" == "true" ]; then
            export LOG_LEVEL=DEBUG
          fi
          
          # è¿è¡Œå¯¹åº”æ“ä½œçš„è„šæœ¬
          echo "æ‰§è¡Œæ“ä½œ: ${{ steps.determine_action.outputs.action }}"
          python scripts/proxy_manager.py --action ${{ steps.determine_action.outputs.action }} --source ${{ steps.determine_action.outputs.proxy_source }} --threshold ${{ steps.determine_action.outputs.threshold }}
          
          # æ£€æŸ¥æ‰§è¡Œç»“æœ
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "âœ… ä»£ç†æ± ç®¡ç†è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            echo "success=true" >> $GITHUB_OUTPUT
            
            # æ£€æŸ¥ä»£ç†æ•°é‡æ˜¯å¦æ»¡è¶³æœ€ä½è¦æ±‚
            if [ -f "status/proxies/pool_status.json" ]; then
              valid_count=$(cat status/proxies/pool_status.json | jq '.stats.valid_count')
              threshold="${{ steps.determine_action.outputs.threshold }}"
              
              if [ "$valid_count" -lt "$threshold" ] && [ "${{ steps.determine_action.outputs.action }}" == "recover" ]; then
                echo "âš ï¸ æ¢å¤åä»£ç†æ•°é‡ä»ä½äºé˜ˆå€¼ï¼Œéœ€è¦æ‰§è¡Œå¤‡ç”¨æ“ä½œ"
                echo "need_fallback=true" >> $GITHUB_OUTPUT
              else
                echo "need_fallback=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "âŒ ä»£ç†æ± ç®¡ç†è„šæœ¬æ‰§è¡Œå¤±è´¥ (é€€å‡ºä»£ç : $exit_code)"
            echo "success=false" >> $GITHUB_OUTPUT
            
            # å¦‚æœä¸»æ“ä½œå¤±è´¥ä¸”æœ‰å¤‡ç”¨æ“ä½œï¼Œæ ‡è®°éœ€è¦æ‰§è¡Œå¤‡ç”¨æ“ä½œ
            if [ -n "${{ steps.determine_action.outputs.fallback }}" ]; then
              echo "âš ï¸ ä¸»æ“ä½œå¤±è´¥ï¼Œéœ€è¦æ‰§è¡Œå¤‡ç”¨æ“ä½œ"
              echo "need_fallback=true" >> $GITHUB_OUTPUT
            else
              echo "need_fallback=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: è¿è¡Œå¤‡ç”¨æ“ä½œ
        if: (steps.run_manager.outputs.success == 'false' || steps.run_manager.outputs.need_fallback == 'true') && steps.determine_action.outputs.fallback != ''
        id: run_fallback
        env:
          PROXY_API_KEY: ${{ secrets.PROXY_API_KEY }}
          PROXY_SOURCE_URL: ${{ secrets.PROXY_SOURCE_URL }}
          DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
        run: |
          echo "æ‰§è¡Œå¤‡ç”¨æ“ä½œ: ${{ steps.determine_action.outputs.fallback }}"
          python scripts/proxy_manager.py --action ${{ steps.determine_action.outputs.fallback }} --source ${{ steps.determine_action.outputs.proxy_source }} --threshold ${{ steps.determine_action.outputs.threshold }}
          
          # æ£€æŸ¥æ‰§è¡Œç»“æœ
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "âœ… å¤‡ç”¨æ“ä½œæ‰§è¡ŒæˆåŠŸ"
            echo "fallback_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ å¤‡ç”¨æ“ä½œæ‰§è¡Œå¤±è´¥ (é€€å‡ºä»£ç : $exit_code)"
            echo "fallback_success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: æäº¤ä»£ç†æ± çŠ¶æ€
        if: steps.run_manager.outputs.success == 'true' || steps.run_fallback.outputs.fallback_success == 'true'
        run: |
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ çŠ¶æ€æ–‡ä»¶
          git add status/proxies/pool_status.json
          git add data/proxies/
          
          # æäº¤æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰ä»£ç†æ± çŠ¶æ€å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            # è·å–å½“å‰ä»£ç†ç»Ÿè®¡
            if [ -f "status/proxies/pool_status.json" ]; then
              valid_count=$(cat status/proxies/pool_status.json | jq '.stats.valid_count')
              failed_count=$(cat status/proxies/pool_status.json | jq '.stats.failed_count')
              
              # åˆ›å»ºæäº¤ä¿¡æ¯
              commit_msg="ğŸ”„ è‡ªåŠ¨æ›´æ–°: ä»£ç†æ± çŠ¶æ€"
              
              if [ "${{ steps.run_manager.outputs.success }}" == "true" ]; then
                commit_msg="${commit_msg} (æ“ä½œ:${{ steps.determine_action.outputs.action }})"
              elif [ "${{ steps.run_fallback.outputs.fallback_success }}" == "true" ]; then
                commit_msg="${commit_msg} (æ“ä½œ:${{ steps.determine_action.outputs.fallback }})"
              fi
              
              commit_msg="${commit_msg} (æœ‰æ•ˆ:$valid_count, å¤±æ•ˆ:$failed_count)"
              
              git commit -m "$commit_msg"
              git push
              echo "âœ… æˆåŠŸæäº¤ä»£ç†æ± çŠ¶æ€æ›´æ–°"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ä»£ç†æ± çŠ¶æ€æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
            fi
          fi
      
      - name: å‡†å¤‡é€šçŸ¥å†…å®¹
        id: prepare_message
        if: always()
        run: |
          if [ -f "status/proxies/pool_status.json" ]; then
            valid_count=$(cat status/proxies/pool_status.json | jq '.stats.valid_count')
            failed_count=$(cat status/proxies/pool_status.json | jq '.stats.failed_count')
            
            if [ "${{ steps.run_manager.outputs.success }}" == "true" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message<<EOF" >> $GITHUB_OUTPUT
              echo "### âœ… ä»£ç†æ± ç®¡ç†ä»»åŠ¡å®Œæˆ" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "- **æ“ä½œ**: ${{ steps.determine_action.outputs.action }}" >> $GITHUB_OUTPUT
              echo "- **æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
              echo "- **ç»“æœ**: æœ‰æ•ˆä»£ç† $valid_count ä¸ª, å¤±æ•ˆä»£ç† $failed_count ä¸ª" >> $GITHUB_OUTPUT
              echo "- **è¿è¡ŒID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            elif [ "${{ steps.run_fallback.outputs.fallback_success }}" == "true" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message<<EOF" >> $GITHUB_OUTPUT
              echo "### âœ… ä»£ç†æ± ç®¡ç†ä»»åŠ¡å®Œæˆ (å¤‡ç”¨æ“ä½œ)" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "- **ä¸»æ“ä½œ**: ${{ steps.determine_action.outputs.action }} (å¤±è´¥)" >> $GITHUB_OUTPUT
              echo "- **å¤‡ç”¨æ“ä½œ**: ${{ steps.determine_action.outputs.fallback }} (æˆåŠŸ)" >> $GITHUB_OUTPUT
              echo "- **æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
              echo "- **ç»“æœ**: æœ‰æ•ˆä»£ç† $valid_count ä¸ª, å¤±æ•ˆä»£ç† $failed_count ä¸ª" >> $GITHUB_OUTPUT
              echo "- **è¿è¡ŒID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "message<<EOF" >> $GITHUB_OUTPUT
              echo "### âŒ ä»£ç†æ± ç®¡ç†ä»»åŠ¡å¤±è´¥" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "- **æ“ä½œ**: ${{ steps.determine_action.outputs.action }}" >> $GITHUB_OUTPUT
              if [ -n "${{ steps.determine_action.outputs.fallback }}" ]; then
                echo "- **å¤‡ç”¨æ“ä½œ**: ${{ steps.determine_action.outputs.fallback }} (ä¹Ÿå¤±è´¥)" >> $GITHUB_OUTPUT
              fi
              echo "- **æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
              echo "- **è¿è¡ŒID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### âš ï¸ ä»£ç†æ± ç®¡ç†ä»»åŠ¡è­¦å‘Š" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **æ“ä½œ**: ${{ steps.determine_action.outputs.action }}" >> $GITHUB_OUTPUT
            echo "- **é—®é¢˜**: æœªæ‰¾åˆ°ä»£ç†æ± çŠ¶æ€æ–‡ä»¶" >> $GITHUB_OUTPUT
            echo "- **æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
            echo "- **è¿è¡ŒID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: æ£€æŸ¥é’‰é’‰é€šçŸ¥é…ç½®
        id: check_dingtalk
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'dingtalk'
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT
      
      - name: å‘é€é€šçŸ¥
        if: steps.check_dingtalk.outputs.has_webhook == 'true'
        uses: fifsky/dingtalk-action@master
        with:
          url: ${{ secrets.DINGTALK_WEBHOOK }}
          type: markdown
          content: ${{ steps.prepare_message.outputs.message }}
          at: all 