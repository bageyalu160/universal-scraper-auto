name: {{ site_name }} çˆ¬è™«ä»»åŠ¡

# å·¥ä½œæµè¿è¡Œåç§°ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
run-name: "ğŸ•¸ï¸ {{ site_name }}çˆ¬è™« #${{ github.run_number }} (${{ github.actor }} è§¦å‘)"

# å¤šç§è§¦å‘æ–¹å¼ç»„åˆ
on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œå¸¦å‚æ•°
  workflow_dispatch:
    inputs:
      date:
        description: 'æ•°æ®æ—¥æœŸ (ç•™ç©ºåˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ)'
        required: false
        type: string
      debug:
        description: 'æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: false
        type: boolean
      keywords:
        description: 'æœç´¢å…³é”®è¯ (ä»¥é€—å·åˆ†éš”)'
        required: false
        type: string
  
  # å®šæ—¶è§¦å‘
  schedule:
    - cron: "{{ cron_schedule }}"
  
  # ä»£ç å˜æ›´è§¦å‘ - ä»…å½“é…ç½®æ–‡ä»¶æˆ–è„šæœ¬æ”¹å˜æ—¶
  push:
    branches: [ main ]
    paths:
      - 'config/sites/{{ site_id }}.yaml'
      - 'src/scrapers/**'
      - '.github/workflows/crawler_{{ site_id }}.yml'

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: "{{ python_version }}"
  SITE_ID: "{{ site_id }}"
  TZ: "Asia/Shanghai"
  # ä½¿ç”¨shellå‘½ä»¤å®šä¹‰æ—¥æœŸ
  RUN_DATE: {% raw %}${{ github.event.inputs.date || '' }}{% endraw %}
  # ä»£ç†æ± å’Œåçˆ¬æœºåˆ¶é…ç½®
  USE_PROXY: {% raw %}${{ vars.USE_PROXY || 'true' }}{% endraw %}
  ROTATE_PROXY: {% raw %}${{ vars.ROTATE_PROXY || 'true' }}{% endraw %}
  ANTI_DETECT_ENABLED: {% raw %}${{ vars.ANTI_DETECT_ENABLED || 'true' }}{% endraw %}
  # æ·»åŠ é»‘çŒ«æŠ•è¯‰Cookieç¯å¢ƒå˜é‡
  HEIMAO_COOKIE: {% raw %}${{ secrets.HEIMAO_COOKIE }}{% endraw %}

# å®šä¹‰å·¥ä½œæµçš„æƒé™
permissions:
  contents: write  # å…è®¸æ¨é€åˆ°ä»“åº“
  actions: write   # å…è®¸è§¦å‘å…¶ä»–å·¥ä½œæµ

# å…¨å±€é»˜è®¤é…ç½®
defaults:
  run:
    shell: bash

# å¹¶å‘æ§åˆ¶ - é¿å…ç›¸åŒç«™ç‚¹çš„ä»»åŠ¡å¹¶è¡Œè¿è¡Œ
concurrency:
  group: crawler-{{ site_id }}-{% raw %}${{ github.ref }}{% endraw %}
  cancel-in-progress: true

jobs:
  # é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    name: ç¯å¢ƒä¸é…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      run_date: {% raw %}${{ steps.prepare_env.outputs.date }}{% endraw %}
      cache_key: {% raw %}${{ steps.prepare_env.outputs.cache_key }}{% endraw %}
      site_config_valid: {% raw %}${{ steps.validate_config.outputs.valid }}{% endraw %}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å‡†å¤‡ç¯å¢ƒå˜é‡
        id: prepare_env
        run: |
          # è®¾ç½®è¿è¡Œæ—¥æœŸ
          if [ -n "$RUN_DATE" ]; then
            echo "ä½¿ç”¨æŒ‡å®šæ—¥æœŸ: $RUN_DATE"
            echo "date=$RUN_DATE" >> $GITHUB_OUTPUT
          else
            echo "ä½¿ç”¨å½“å‰æ—¥æœŸ"
            echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
          
          # ç”Ÿæˆç¼“å­˜é”®
          if [ -f "requirements.txt" ]; then
            HASH=$(sha256sum requirements.txt | cut -d ' ' -f 1 | head -c 8)
            echo "cache_key=deps-${{ site_id }}-$HASH-v1" >> $GITHUB_OUTPUT
          else
            echo "cache_key=deps-${{ site_id }}-default-v1" >> $GITHUB_OUTPUT
          fi
      
      - name: éªŒè¯ç«™ç‚¹é…ç½®
        id: validate_config
        run: |
          if [ -f "config/sites/$SITE_ID.yaml" ]; then
            echo "âœ… ç«™ç‚¹é…ç½®æœ‰æ•ˆ"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # çˆ¬è™«ä½œä¸š - ä½¿ç”¨çŸ©é˜µç­–ç•¥æ”¯æŒå¤šå¼•æ“
  crawl:
    name: è¿è¡Œçˆ¬è™«
    needs: pre-check
    runs-on: ubuntu-latest
    env:
      RUN_DATE: {% raw %}${{ needs.pre-check.outputs.run_date }}{% endraw %}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: {% raw %}${{ env.PYTHON_VERSION }}{% endraw %}
          cache: "pip"
          cache-dependency-path: "**/requirements.txt"
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "å®‰è£…å¿…è¦çš„ä¾èµ–..."
            pip install {{ scraper_dependencies }}
          fi

      # æ–°å¢æ­¥éª¤ï¼šæ£€æŸ¥ä»£ç†æ± çŠ¶æ€
      - name: æ£€æŸ¥ä»£ç†æ± çŠ¶æ€
        id: check_proxy_pool
        if: env.USE_PROXY == 'true'
        run: |
          if [ -f "status/proxies/pool_status.json" ]; then
            echo "ä»£ç†æ± çŠ¶æ€æ–‡ä»¶å­˜åœ¨"
            # è·å–æœ‰æ•ˆä»£ç†æ•°é‡
            valid_count=$(cat status/proxies/pool_status.json | jq '.valid_proxies | length')
            echo "æœ‰æ•ˆä»£ç†æ•°é‡: $valid_count"
            
            if [ "$valid_count" -lt "5" ]; then
              echo "âš ï¸ æœ‰æ•ˆä»£ç†æ•°é‡ä¸è¶³ï¼Œå°è¯•æ›´æ–°ä»£ç†æ± "
              echo "needs_update=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… ä»£ç†æ± çŠ¶æ€æ­£å¸¸"
              echo "needs_update=false" >> $GITHUB_OUTPUT
            fi
            echo "pool_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ä»£ç†æ± çŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦åˆå§‹åŒ–"
            echo "pool_exists=false" >> $GITHUB_OUTPUT
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
      
      # æ–°å¢æ­¥éª¤ï¼šæ›´æ–°ä»£ç†æ± (å¦‚æœéœ€è¦)
      - name: æ›´æ–°ä»£ç†æ± 
        if: env.USE_PROXY == 'true' && steps.check_proxy_pool.outputs.needs_update == 'true'
        env:
          PROXY_API_KEY: {% raw %}${{ secrets.PROXY_API_KEY }}{% endraw %}
          PROXY_SOURCE_URL: {% raw %}${{ secrets.PROXY_SOURCE_URL }}{% endraw %}
        run: |
          echo "æ‰§è¡Œä»£ç†æ± æ›´æ–°..."
          
          if [ "{% raw %}${{ steps.check_proxy_pool.outputs.pool_exists }}{% endraw %}" == "true" ]; then
            # æ›´æ–°ç°æœ‰ä»£ç†æ± 
            python scripts/proxy_manager.py --action update --source all
          else
            # åˆå§‹åŒ–ä»£ç†æ± 
            python scripts/proxy_manager.py --action rebuild --source all
          fi
          
          # æ£€æŸ¥æ›´æ–°ç»“æœ
          if [ -f "status/proxies/pool_status.json" ]; then
            valid_count=$(cat status/proxies/pool_status.json | jq '.valid_proxies | length')
            echo "æ›´æ–°åæœ‰æ•ˆä»£ç†: $valid_count ä¸ª"
            
            if [ "$valid_count" -eq "0" ]; then
              echo "âš ï¸ è­¦å‘Šï¼šä»£ç†æ± æ›´æ–°åæ— å¯ç”¨ä»£ç†"
            fi
          else
            echo "âŒ ä»£ç†æ± æ›´æ–°å¤±è´¥ï¼ŒçŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨"
          fi
      
      # å®‰è£…Playwright (å¦‚éœ€è¦)
      - name: å®‰è£…Playwright (å¦‚éœ€è¦)
        id: check_engine
        run: |
          # è¯»å–ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­çš„engineå€¼
          ENGINE=$(grep -E "engine:" config/sites/${{ env.SITE_ID }}.yaml | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
          echo "engine=$ENGINE" >> $GITHUB_OUTPUT
          
          # å¦‚æœæ˜¯playwrightæˆ–browserç±»å‹ï¼Œåˆ™å®‰è£…playwright
          if [[ "$ENGINE" == "playwright" || "$ENGINE" == "browser" ]]; then
            echo "éœ€è¦å®‰è£…Playwright"
            pip install playwright
            playwright install --with-deps chromium
          else
            echo "ä¸éœ€è¦å®‰è£…Playwright"
          fi
      
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: |
          mkdir -p {{ data_dir }}/daily/$RUN_DATE
      
      - name: è¿è¡Œçˆ¬è™«
        id: run_scraper
        continue-on-error: true
        env:
{% for env_var in env_vars %}
          {{ env_var.name }}: {% raw %}${{ secrets.{% endraw %}{{ env_var.secret }}{% raw %} }}{% endraw %}
{% endfor %}
          # ä»£ç†æ± ç›¸å…³
          PROXY_API_KEY: {% raw %}${{ secrets.PROXY_API_KEY }}{% endraw %}
          PROXY_SOURCE_URL: {% raw %}${{ secrets.PROXY_SOURCE_URL }}{% endraw %}
          USE_PROXY: {% raw %}${{ env.USE_PROXY }}{% endraw %}
          ROTATE_PROXY: {% raw %}${{ env.ROTATE_PROXY }}{% endraw %}
          
          # åçˆ¬æœºåˆ¶ç›¸å…³
          ANTI_DETECT_ENABLED: {% raw %}${{ env.ANTI_DETECT_ENABLED }}{% endraw %}
          CAPTCHA_API_KEY: {% raw %}${{ secrets.CAPTCHA_API_KEY }}{% endraw %}
          CAPTCHA_SERVICE: {% raw %}${{ vars.CAPTCHA_SERVICE || '2captcha' }}{% endraw %}
          BROWSER_FINGERPRINT: {% raw %}${{ vars.BROWSER_FINGERPRINT || 'true' }}{% endraw %}
          
          # åŸæœ‰ç¯å¢ƒå˜é‡
          HEIMAO_COOKIE: {% raw %}${{ secrets.HEIMAO_COOKIE }}{% endraw %}
          HEIMAO_KEYWORDS: {% raw %}${{ github.event.inputs.keywords || vars.HEIMAO_KEYWORDS || '' }}{% endraw %}
          ENABLE_NOTIFICATION: {% raw %}${{ vars.ENABLE_NOTIFICATION || 'false' }}{% endraw %}
          NOTIFICATION_TYPE: {% raw %}${{ vars.NOTIFICATION_TYPE || 'none' }}{% endraw %}
          NOTIFICATION_WEBHOOK: {% raw %}${{ vars.NOTIFICATION_WEBHOOK || '' }}{% endraw %}
          DEBUG_MODE: {% raw %}${{ github.event.inputs.debug || 'false' }}{% endraw %}
        run: |
          echo "ğŸ“Œ å¼€å§‹è¿è¡Œçˆ¬è™« (ç«™ç‚¹: $SITE_ID, æ—¥æœŸ: $RUN_DATE)"
          
          if [ "$DEBUG_MODE" = "true" ]; then
            echo "ğŸ” è°ƒè¯•æ¨¡å¼å·²å¯ç”¨"
            export LOG_LEVEL=DEBUG
          fi
          
          # è®°å½•ä»£ç†å’Œåçˆ¬è®¾ç½®
          echo "ğŸ”’ ä»£ç†è®¾ç½®: USE_PROXY=$USE_PROXY, ROTATE_PROXY=$ROTATE_PROXY"
          echo "ğŸ›¡ï¸ åçˆ¬è®¾ç½®: ANTI_DETECT_ENABLED=$ANTI_DETECT_ENABLED, BROWSER_FINGERPRINT=$BROWSER_FINGERPRINT"
          
          # è¿è¡Œçˆ¬è™«è„šæœ¬
          python {{ scraper_script }} --site $SITE_ID --config config/sites/$SITE_ID.yaml --output {{ data_dir }}/daily/$RUN_DATE/
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            if [ -f "{{ output_filename }}" ]; then
              echo "âœ… çˆ¬è™«æˆåŠŸå®Œæˆï¼Œå·²ç”Ÿæˆæ•°æ®æ–‡ä»¶"
              echo "file_exists=true" >> $GITHUB_OUTPUT
              echo "file_size=$(stat -c%s {{ output_filename }})" >> $GITHUB_OUTPUT
              echo "file_path={{ output_filename }}" >> $GITHUB_OUTPUT
              
              # å¤åˆ¶åˆ°æ—¥æœŸç›®å½•
              cp {{ output_filename }} {{ data_dir }}/daily/$RUN_DATE/
              echo "æ•°æ®æ–‡ä»¶å·²å¤åˆ¶åˆ°æ—¥æœŸç›®å½•"
            else
              echo "âš ï¸ çˆ¬è™«è¿›ç¨‹æˆåŠŸä½†æœªæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶"
              echo "file_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ çˆ¬è™«è¿›ç¨‹å¤±è´¥ (é€€å‡ºä»£ç : $exit_code)"
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: åˆ›å»ºçˆ¬è™«çŠ¶æ€æ–‡ä»¶
        run: |
          mkdir -p {{ status_dir }}
          if [ "{% raw %}${{ steps.run_scraper.outputs.file_exists }}{% endraw %}" == "true" ]; then
            cat > {{ status_dir }}/crawler_$SITE_ID.json << EOF
            {
              "status": "success",
              "site_id": "$SITE_ID",
              "date": "$RUN_DATE",
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "file_path": "{{ data_dir }}/daily/$RUN_DATE/{{ output_filename }}",
              "file_size": "{% raw %}${{ steps.run_scraper.outputs.file_size }}{% endraw %}",
              "run_id": "{% raw %}${{ github.run_id }}{% endraw %}",
              "run_url": "{% raw %}${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}{% endraw %}",
              "message": "çˆ¬è™«è¿è¡ŒæˆåŠŸ"
            }
            EOF
          else
            cat > {{ status_dir }}/crawler_$SITE_ID.json << EOF
            {
              "status": "failed",
              "site_id": "$SITE_ID",
              "date": "$RUN_DATE",
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "run_id": "{% raw %}${{ github.run_id }}{% endraw %}",
              "run_url": "{% raw %}${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}{% endraw %}",
              "message": "çˆ¬è™«è¿è¡Œå¤±è´¥æˆ–æœªç”Ÿæˆæ–‡ä»¶"
            }
            EOF
          fi
          echo "å·²åˆ›å»ºçˆ¬è™«çŠ¶æ€æ–‡ä»¶"
      
      - name: æäº¤ç»“æœåˆ°ä»“åº“
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add {{ data_dir }}/daily/$RUN_DATE/ || echo "æ²¡æœ‰æ•°æ®ç›®å½•å˜æ›´"
          git add {{ output_filename }} || echo "æ²¡æœ‰ä¸»æ•°æ®æ–‡ä»¶"
          git add {{ status_dir }}/crawler_$SITE_ID.json
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: {{ site_name }}çˆ¬è™«æ•°æ® ($RUN_DATE)"
            git push
            echo "âœ… æˆåŠŸæäº¤å¹¶æ¨é€çˆ¬è™«ç»“æœ"
          fi
      
      - name: ä¸Šä¼ çˆ¬å–æ•°æ® (ä½œä¸ºå·¥ä»¶)
        if: {% raw %}steps.run_scraper.outputs.file_exists == 'true'{% endraw %}
        uses: actions/upload-artifact@v4
        with:
          name: {{ site_id }}-data-${% raw %}{{ needs.pre-check.outputs.run_date }}{% endraw %}
          path: |
            {{ data_dir }}/daily/${% raw %}{{ needs.pre-check.outputs.run_date }}{% endraw %}/
            {{ output_filename }}
          retention-days: 5

      {% if run_analysis %}
      # è§¦å‘åˆ†æå·¥ä½œæµ
      - name: è§¦å‘åˆ†æå·¥ä½œæµ
        if: {% raw %}steps.run_scraper.outputs.file_exists == 'true'{% endraw %}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: analyzer_{{ site_id }}.yml
          token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
          inputs: '{"data_date": "{% raw %}${{ needs.pre-check.outputs.run_date }}{% endraw %}", "data_file": "{{ data_dir }}/daily/{% raw %}${{ needs.pre-check.outputs.run_date }}{% endraw %}/{{ output_filename }}", "site_id": "{{ site_id }}"}'
      {% endif %}

  # é€šçŸ¥ä½œä¸š
  notify:
    name: å‘é€é€šçŸ¥
    needs: [pre-check, crawl]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç 
        if: {% raw %}contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled'){% endraw %}
        uses: actions/checkout@v4
      
      - name: å‡†å¤‡é€šçŸ¥å†…å®¹
        id: prepare_message
        run: |
          if [[ "{% raw %}${{ needs.crawl.result }}{% endraw %}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=#00FF00" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### âœ… {{ site_name }}çˆ¬è™«ä»»åŠ¡æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **ç«™ç‚¹**: {{ site_name }}" >> $GITHUB_OUTPUT
            echo "- **æ—¥æœŸ**: {% raw %}${{ needs.pre-check.outputs.run_date }}{% endraw %}" >> $GITHUB_OUTPUT
            echo "- **è¿è¡ŒID**: [#{% raw %}${{ github.run_number }}{% endraw %}]({% raw %}${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}{% endraw %})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=#FF0000" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### âŒ {{ site_name }}çˆ¬è™«ä»»åŠ¡å¤±è´¥" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **ç«™ç‚¹**: {{ site_name }}" >> $GITHUB_OUTPUT
            echo "- **æ—¥æœŸ**: {% raw %}${{ needs.pre-check.outputs.run_date }}{% endraw %}" >> $GITHUB_OUTPUT
            echo "- **å¤±è´¥é˜¶æ®µ**: {% raw %}${{ needs.crawl.result == 'failure' && 'Crawl' || 'Pre-Check' }}{% endraw %}" >> $GITHUB_OUTPUT
            echo "- **è¿è¡ŒID**: [#{% raw %}${{ github.run_number }}{% endraw %}]({% raw %}${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}{% endraw %})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: æ£€æŸ¥é’‰é’‰é€šçŸ¥é…ç½®
        id: check_dingtalk
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'dingtalk'
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT
          
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: steps.check_dingtalk.outputs.has_webhook == 'true'
        uses: fifsky/dingtalk-action@master
        with:
          url: {% raw %}${{ secrets.DINGTALK_WEBHOOK }}{% endraw %}
          type: markdown
          content: |
            {% raw %}${{ steps.prepare_message.outputs.message }}{% endraw %}
      
      - name: æ£€æŸ¥ä¼ä¸šå¾®ä¿¡é…ç½®
        id: check_wechat
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'wechat'
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT
          
      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if: steps.check_wechat.outputs.has_webhook == 'true'
        uses: chf007/action-wechat-work@master
        with:
          msgtype: markdown
          content: {% raw %}${{ steps.prepare_message.outputs.message }}{% endraw %}
          key: {% raw %}${{ secrets.WECHAT_WEBHOOK }}{% endraw %} 