name: æ›´æ–°ç›‘æ§ä»ªè¡¨ç›˜

run-name: "ğŸ“Š æ›´æ–°ç›‘æ§ä»ªè¡¨ç›˜ (${{ github.actor }})"

on:
  workflow_dispatch:
    inputs:
      site_id:
        description: "ç«™ç‚¹ID"
        required: false
        type: string

  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹æ›´æ–°

  # ç”±å…¶ä»–å·¥ä½œæµè§¦å‘
  workflow_call:
    inputs:
      site_id:
        description: "ç«™ç‚¹ID"
        required: false
        type: string

permissions:
  contents: write # å…è®¸æ¨é€åˆ°ä»“åº“
  pages: write # å…è®¸éƒ¨ç½²Pages
  id-token: write # å…è®¸ä½¿ç”¨OIDC

# ç¡®ä¿åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªä»ªè¡¨ç›˜æ›´æ–°
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: æ„å»ºä»ªè¡¨ç›˜
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas matplotlib seaborn jinja2

      - name: ç”Ÿæˆä»ªè¡¨ç›˜æ•°æ®
        run: |
          python scripts/update_dashboard.py {% raw %}${{ github.event.inputs.site_id && format('--site {0}', github.event.inputs.site_id) || '--all' }}{% endraw %}

      - name: è®¾ç½®Pages
        uses: actions/configure-pages@v4

      - name: æ„å»ºé™æ€æ–‡ä»¶
        run: |
          mkdir -p _site
          cp -r .github/pages/dashboard/* _site/
          cp -r status _site/data/
          cp -r dashboard/* _site/

      - name: ä¸Šä¼ é¡µé¢å·¥ä»¶
        uses: actions/upload-pages-artifact@v2
        with:
          path: "_site"

  deploy:
    name: éƒ¨ç½²ä»ªè¡¨ç›˜
    needs: build
    runs-on: ubuntu-latest

    # ç¯å¢ƒé…ç½®
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3

  notify:
    name: å‘é€éƒ¨ç½²é€šçŸ¥
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: å‡†å¤‡é€šçŸ¥å†…å®¹
        id: prepare_message
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### âœ… ç›‘æ§ä»ªè¡¨ç›˜æ›´æ–°æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **URL**: ${{ needs.deploy.outputs.page_url }}" >> $GITHUB_OUTPUT
            echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
            echo "- **è¿è¡ŒID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message<<EOF" >> $GITHUB_OUTPUT
            echo "### âŒ ç›‘æ§ä»ªè¡¨ç›˜æ›´æ–°å¤±è´¥" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "- **å¤±è´¥é˜¶æ®µ**: ${{ needs.deploy.result == 'failure' && 'Deployment' || 'Build' }}" >> $GITHUB_OUTPUT
            echo "- **è¿è¡ŒID**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥é’‰é’‰é€šçŸ¥é…ç½®
        id: check_dingtalk
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'dingtalk'
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT

      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: steps.check_dingtalk.outputs.has_webhook == 'true'
        uses: fifsky/dingtalk-action@master
        with:
          url: ${{ secrets.DINGTALK_WEBHOOK }}
          type: markdown
          content: |
            ${{ steps.prepare_message.outputs.message }}

      - name: æ£€æŸ¥ä¼ä¸šå¾®ä¿¡é…ç½®
        id: check_wechat
        if: vars.ENABLE_NOTIFICATION == 'true' && vars.NOTIFICATION_TYPE == 'wechat'
        run: |
          echo "has_webhook=true" >> $GITHUB_OUTPUT

      - name: å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
        if: steps.check_wechat.outputs.has_webhook == 'true'
        uses: chf007/action-wechat-work@master
        with:
          msgtype: markdown
          content: ${{ steps.prepare_message.outputs.message }}
          key: ${{ secrets.WECHAT_WEBHOOK }}
